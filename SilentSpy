-- Silent Spy - Fully Optimized (No Lag, No Camera Freeze)
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

-- Create main window
local Window = WindUI:CreateWindow({
    Title = "SilentSpy - Fryzer Hub",
    Author = "",
    Folder = "FryzerRemoteSpy",
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = false,
    ScrollBarEnabled = true,
})

Window:EditOpenButton({
    Title = "Silent Spy",
    CornerRadius = UDim.new(0, 16),
    StrokeThickness = 2,
    Color = ColorSequence.new(Color3.fromHex("00AAFF"), Color3.fromHex("0088cc")),
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

Window:Tag({
    Title = "v2.6.7",
    Color = Color3.fromHex("#30ff6a"),
    Radius = 7,
})

Window:Tag({
    Title = "Rspy",
    Color = Color3.fromHex("#FF0000"),
    Radius = 8,
})

WindUI:SetNotificationLower(true)

-- Global variables
local remoteConnections = {}
local remoteCounts = {}
local remoteTabs = {}
local capturedRemotes = {}
local pendingCaptures = {}
local blockedRemotes = {}
local remoteFireCounts = {}
local AUTO_BLOCK_THRESHOLD = 50
local DEBUG_MODE = false
local NOTIFICATIONS_ENABLED = false
local AUTO_BAN_ENABLED = false
local unblockedRemotesList = {}

-- OPTIMIZATION: Limits to prevent lag
local MAX_TABS = 25
local MAX_PENDING = 15
local PROCESS_DELAY = 0.3

local InfoTab = Window:Tab({
    Title = "Info",
    Icon = "info",
    Locked = false,
})

InfoTab:Paragraph({
    Title = "Silent Spy Active",
    Desc = "This tool captures remote events and functions. Auto-blocks remotes firing 50+ times. Click 'Block Remote' to manually block.",
    Color = "Blue",
    Locked = false,
})

InfoTab:Divider()

local Section = InfoTab:Section({ 
    Title = "Settings",
})

local NotificationToggle = InfoTab:Toggle({
    Title = "Notifications",
    Desc = "Enable/Disable all notifications",
    Icon = "bell",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        NOTIFICATIONS_ENABLED = state
        print("Notifications: " .. tostring(state))
    end
})

local AutoBanToggle = InfoTab:Toggle({
    Title = "Auto-Ban",
    Desc = "Automatically block remotes after 50+ fires",
    Icon = "shield",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        AUTO_BAN_ENABLED = state
        print("Auto-Ban: " .. tostring(state))
    end
})

local UnblockAllButton = InfoTab:Button({
    Title = "Unblock All Remotes",
    Desc = "Unblock all currently blocked remotes",
    Locked = false,
    Callback = function()
        local count = 0
        for path, _ in pairs(blockedRemotes) do
            blockedRemotes[path] = nil
            remoteFireCounts[path] = 0
            table.insert(unblockedRemotesList, path)
            count = count + 1
        end
        
        if count > 0 then
            if NOTIFICATIONS_ENABLED then
                WindUI:Notify({
                    Title = "Unblocked All",
                    Content = "Unblocked " .. count .. " remote(s)",
                    Duration = 3
                })
            else
                print("Unblocked " .. count .. " remote(s)")
            end
        else
            if NOTIFICATIONS_ENABLED then
                WindUI:Notify({
                    Title = "No Remotes",
                    Content = "No blocked remotes found",
                    Duration = 3
                })
            else
                print("No blocked remotes to unblock")
            end
        end
    end
})

-- OPTIMIZATION: Clear old tabs button
InfoTab:Button({
    Title = "Clear Old Tabs",
    Desc = "Remove old tabs to improve performance",
    Locked = false,
    Callback = function()
        local removed = 0
        while #remoteTabs > 10 do
            local oldTab = table.remove(remoteTabs)
            if oldTab and oldTab.tab then
                pcall(function() oldTab.tab:Destroy() end)
                removed = removed + 1
            end
        end
        if removed > 0 then
            if NOTIFICATIONS_ENABLED then
                WindUI:Notify({
                    Title = "Cleaned Up",
                    Content = "Removed " .. removed .. " old tabs",
                    Duration = 2
                })
            else
                print("Removed " .. removed .. " old tabs")
            end
        end
    end
})

local Section2 = InfoTab:Section({ 
    Title = "Join Our Discord Community",
})

InfoTab:Paragraph({
    Title = "ðŸŽ® Connect & Engage",
    Desc = "Join members of players in our Discord community, and for updates, support, and exclusive content!",
    Color = "Blue",
    Image = "",
    ImageSize = 30,
    Thumbnail = "",
    ThumbnailSize = 80,
    Locked = false,
    Buttons = {}
})

InfoTab:Button({
    Title = "ðŸ“‹ Copy Discord Link",
    Desc = "Copy invite link to clipboard",
    Locked = false,
    Callback = function()
        setclipboard("https://discord.gg/UKYHGddQD3")
        WindUI:Notify({
            Title = "âœ… Link Copied!",
            Content = "Discord invite copied to clipboard",
            Duration = 3,
            Icon = "copy",
        })
    end
})

InfoTab:Space()

InfoTab:Paragraph({
    Title = "Credits",
    Desc = "Owner - Fryzer Hub \n Thanks to: \n â— Wind ui & footagesus \n â— Sigma Spy \n â— ChrislsTaken ",
    Color = "White",
    Locked = false,
})

-- OPTIMIZATION: Path caching
local pathCache = setmetatable({}, {__mode = "k"})

local function getPathToInstance(instance)
    if pathCache[instance] then
        return pathCache[instance]
    end
    
    local path = {}
    local current = instance
    while current and current ~= game do
        table.insert(path, 1, current.Name)
        current = current.Parent
    end
    local fullPath = "game." .. table.concat(path, ".")
    pathCache[instance] = fullPath
    return fullPath
end

local function formatValue(value)
    if typeof(value) == "string" then
        return string.format("%q", value)
    elseif typeof(value) == "number" then
        return tostring(value)
    elseif typeof(value) == "boolean" then
        return value and "true" or "false"
    elseif typeof(value) == "Instance" then
        return getPathToInstance(value)
    else
        return string.format("%q", tostring(value))
    end
end

local function Format(args)
    local formattedArgs = {}
    for i, arg in ipairs(args) do
        formattedArgs[i] = string.format("[%d] = %s", i, formatValue(arg))
    end
    return formattedArgs
end

local function createRemoteTab(data)
    -- OPTIMIZATION: Limit total tabs
    while #remoteTabs >= MAX_TABS do
        local oldTab = table.remove(remoteTabs)
        if oldTab and oldTab.tab then
            pcall(function() oldTab.tab:Destroy() end)
        end
    end
    
    local argsString = table.concat(data.args, ",\n    ")
    
    local code
    if data.class == "RemoteEvent" then
        code = string.format("local args = {\n    %s\n}\n%s:FireServer(unpack(args))", argsString, data.path)
    else
        code = string.format("local args = {\n    %s\n}\n%s:InvokeServer(unpack(args))", argsString, data.path)
    end
    
    if not remoteCounts[data.name] then
        remoteCounts[data.name] = 0
    end
    remoteCounts[data.name] = remoteCounts[data.name] + 1
    
    local displayName = data.name .. " [" .. remoteCounts[data.name] .. "]"
    
    local newTab = Window:Tab({
        Title = displayName,
        Icon = "radio",
        Locked = false,
    })
    
    local codeDisplay = newTab:Code({
        Title = "Remote Event Code",
        Code = code
    })
    
    local actionsSection = newTab:Section({
        Title = "Actions",
        Icon = "settings",
        Opened = true,
    })
    
    actionsSection:Button({
        Title = "Copy Code",
        Desc = "Copy the code to clipboard",
        Locked = false,
        Callback = function()
            if setclipboard then
                setclipboard(code)
                if NOTIFICATIONS_ENABLED then
                    WindUI:Notify({
                        Title = "Success",
                        Content = "Code copied to clipboard!",
                        Duration = 3
                    })
                end
            end
        end
    })
    
    actionsSection:Button({
        Title = "Copy Remote Path",
        Desc = "Copy the remote's full path",
        Locked = false,
        Callback = function()
            if setclipboard then
                setclipboard(data.path)
                if NOTIFICATIONS_ENABLED then
                    WindUI:Notify({
                        Title = "Success",
                        Content = "Path copied to clipboard!",
                        Duration = 3
                    })
                end
            end
        end
    })
    
    actionsSection:Button({
        Title = "Run Code",
        Desc = "Execute the code",
        Locked = false,
        Callback = function()
            local runSuccess, runErr = pcall(function()
                loadstring(code)()
            end)
            if NOTIFICATIONS_ENABLED then
                if runSuccess then
                    WindUI:Notify({
                        Title = "Success",
                        Content = "Code executed successfully!",
                        Duration = 3
                    })
                else
                    WindUI:Notify({
                        Title = "Error",
                        Content = "Execution failed: " .. tostring(runErr),
                        Duration = 5
                    })
                end
            end
        end
    })
    
    actionsSection:Button({
        Title = "Block Remote",
        Desc = "Block this remote from capturing",
        Locked = false,
        Callback = function()
            blockedRemotes[data.path] = true
            if NOTIFICATIONS_ENABLED then
                WindUI:Notify({
                    Title = "Blocked",
                    Content = "Remote blocked: " .. data.name,
                    Duration = 3
                })
            end
        end
    })
    
    local infoSection = newTab:Section({
        Title = "Remote Information",
        Icon = "info",
        Opened = true,
    })
    
    infoSection:Paragraph({
        Title = "Remote Details",
        Desc = "Type: " .. data.class .. "\n\nPath: " .. data.path,
        Color = "Green",
        Locked = false,
    })
    
    table.insert(remoteTabs, 1, {
        tab = newTab,
        name = data.name,
        code = code,
        path = data.path,
    })
    
    if NOTIFICATIONS_ENABLED then
        WindUI:Notify({
            Title = "Remote Captured",
            Content = displayName,
            Duration = 2
        })
    end
end

-- OPTIMIZATION: Process captures with delay to prevent lag
local lastProcess = tick()
game:GetService("RunService").Heartbeat:Connect(function()
    if #pendingCaptures > 0 and (tick() - lastProcess) >= PROCESS_DELAY then
        lastProcess = tick()
        
        -- Limit pending queue
        while #pendingCaptures > MAX_PENDING do
            table.remove(pendingCaptures, 1)
        end
        
        local capture = table.remove(pendingCaptures, 1)
        if capture and not blockedRemotes[capture.path] then
            pcall(createRemoteTab, capture)
        end
    end
end)

-- OPTIMIZATION: Improved namecall hook
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    
    if method == "FireServer" or method == "InvokeServer" then
        local success, capturedData = pcall(function()
            local remoteName = self.Name
            local remoteClass = self.ClassName
            local remotePath = getPathToInstance(self)
            
            local formattedArgs = {}
            for i, arg in ipairs(args) do
                formattedArgs[i] = string.format("[%d] = %s", i, formatValue(arg))
            end
            
            return {
                name = remoteName,
                class = remoteClass,
                path = remotePath,
                args = formattedArgs
            }
        end)
        
        if success and capturedData then
            -- Track fire count
            if not remoteFireCounts[capturedData.path] then
                remoteFireCounts[capturedData.path] = 0
            end
            remoteFireCounts[capturedData.path] = remoteFireCounts[capturedData.path] + 1
            
            -- Check if remote was previously unbanned
            local wasUnbanned = false
            for _, unbanPath in ipairs(unblockedRemotesList) do
                if unbanPath == capturedData.path then
                    wasUnbanned = true
                    break
                end
            end
            
            -- Auto-block if threshold exceeded
            if AUTO_BAN_ENABLED and remoteFireCounts[capturedData.path] >= AUTO_BLOCK_THRESHOLD and not blockedRemotes[capturedData.path] and not wasUnbanned then
                blockedRemotes[capturedData.path] = true
                if NOTIFICATIONS_ENABLED then
                    WindUI:Notify({
                        Title = "Auto-Blocked",
                        Content = "Remote auto-blocked (fired " .. remoteFireCounts[capturedData.path] .. " times): " .. capturedData.name,
                        Duration = 4
                    })
                end
            end
            
            if not blockedRemotes[capturedData.path] then
                local remoteId = capturedData.path .. "_" .. tick()
                if not capturedRemotes[remoteId] then
                    capturedRemotes[remoteId] = true
                    table.insert(pendingCaptures, capturedData)
                end
            end
        end
    end
    
    return oldNamecall(self, ...)
end)

-- OPTIMIZATION: Efficient remote wrapping
local processedRemotes = setmetatable({}, {__mode = "k"})

local function wrapRemote(obj)
    if processedRemotes[obj] or remoteConnections[obj] then
        return
    end
    processedRemotes[obj] = true
    
    if obj:IsA("RemoteEvent") then
        local connection = obj.OnClientEvent:Connect(function(...)
            local path = getPathToInstance(obj)
            
            if not remoteFireCounts[path] then
                remoteFireCounts[path] = 0
            end
            remoteFireCounts[path] = remoteFireCounts[path] + 1
            
            -- Check if remote was previously unbanned
            local wasUnbanned = false
            for _, unbanPath in ipairs(unblockedRemotesList) do
                if unbanPath == path then
                    wasUnbanned = true
                    break
                end
            end
            
            if AUTO_BAN_ENABLED and remoteFireCounts[path] >= AUTO_BLOCK_THRESHOLD and not blockedRemotes[path] and not wasUnbanned then
                blockedRemotes[path] = true
                if NOTIFICATIONS_ENABLED then
                    WindUI:Notify({
                        Title = "Auto-Blocked",
                        Content = "Remote auto-blocked (fired " .. remoteFireCounts[path] .. " times): " .. obj.Name,
                        Duration = 4
                    })
                end
            end
            
            if not blockedRemotes[path] then
                local argsFormatted = Format({...})
                local remoteId = path .. "_" .. tick()
                if not capturedRemotes[remoteId] then
                    capturedRemotes[remoteId] = true
                    table.insert(pendingCaptures, {
                        name = obj.Name,
                        class = "RemoteEvent",
                        path = path,
                        args = argsFormatted
                    })
                end
            end
        end)
        remoteConnections[obj] = connection
    end
end

local function wrapRemotes(folder)
    for _, obj in ipairs(folder:GetDescendants()) do
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            task.spawn(wrapRemote, obj)
        end
    end
    
    folder.DescendantAdded:Connect(function(descendant)
        if descendant:IsA("RemoteEvent") or descendant:IsA("RemoteFunction") then
            task.spawn(function()
                task.wait(0.1)
                wrapRemote(descendant)
            end)
        end
    end)
end

-- Initialize folders
local folders = {
    game.ReplicatedStorage,
    game.StarterGui,
    game.StarterPack,
    game.StarterPlayer,
    game.Workspace
}

for _, folder in ipairs(folders) do
    task.spawn(function()
        wrapRemotes(folder)
    end)
end

-- Global descendant listener
game.DescendantAdded:Connect(function(descendant)
    if descendant:IsA("RemoteEvent") or descendant:IsA("RemoteFunction") then
        task.spawn(function()
            task.wait(0.1)
            wrapRemote(descendant)
        end)
    end
end)

-- OPTIMIZATION: Periodic cleanup
task.spawn(function()
    while task.wait(120) do
        -- Clear old captures
        local count = 0
        for id in pairs(capturedRemotes) do
            count = count + 1
            if count > 500 then
                capturedRemotes[id] = nil
            end
        end
    end
end)

if NOTIFICATIONS_ENABLED then
    WindUI:Notify({
        Title = "Fryzer Hub",
        Content = "Remote Spy loaded successfully!",
        Duration = 4
    })
end
